# CRM Desk Backend

Бэкенд-часть приложения CRM Desk, написанная на TypeScript с использованием Node.js, Express, Socket.IO, Sequelize и Redis.

## Особенности

- Реализация в TypeScript для типобезопасности и лучшей поддерживаемости кода
- Использование Socket.IO для реализации реального времени
- Оптимизация записей в базу данных с использованием RxJS
- Кеширование данных в Redis для быстрого доступа
- Отложенное сохранение изменений объектов (debounce 100ms)
- Использование upsert для предотвращения дублирования объектов
- Система логирования с ротацией файлов
- Механизм ограничения скорости запросов (rate limiting)
- Предотвращение утечек памяти с помощью управления кешем
- Корректное завершение работы сервера с сохранением данных

## Оптимизация записей в базу данных

Для уменьшения количества записей в базу данных реализован механизм отложенного сохранения с использованием RxJS:

- Изменения объектов сначала сохраняются в Redis и кеш
- Объекты добавляются в очередь на сохранение в БД
- Сохранение в БД происходит только через 100ms после последнего изменения объекта
- Объекты группируются по ID, чтобы каждый объект обрабатывался отдельно
- При завершении работы сервера все несохраненные изменения сохраняются в БД
- Используется метод upsert для предотвращения дублирования объектов

## Предотвращение утечек памяти

Для предотвращения утечек памяти реализованы следующие механизмы:

- Ограничение размера кеша комнат с автоматической очисткой
- Время жизни (TTL) для кешированных данных
- Периодическая очистка устаревших данных
- Корректное освобождение ресурсов при завершении работы
- Отслеживание времени последнего доступа к данным
- Очистка неиспользуемых подписок RxJS

## Повышение стабильности

Для повышения стабильности приложения реализованы:

- Система логирования с разделением по уровням и ротацией файлов
- Ограничение скорости запросов для предотвращения DoS-атак
- Обработка необработанных исключений и отклонений промисов
- Корректное завершение работы сервера с таймаутом
- Проверка входных данных перед обработкой
- Маршрут для проверки работоспособности (/health)
- Информативные сообщения об ошибках для клиентов

## Обработка ошибок

- Проверка наличия необходимых полей перед выполнением операций
- Отправка информативных сообщений об ошибках клиентам
- Логирование ошибок на сервере с контекстом
- Корректное завершение работы сервера с сохранением всех данных
- Обработка ошибок сети и базы данных

## Механизм ограничения скорости запросов

Для защиты от DoS-атак и предотвращения перегрузки сервера реализован механизм ограничения скорости запросов:

- По умолчанию ограничение составляет 50 запросов в секунду для каждого клиента
- При превышении лимита клиент получает сообщение об ошибке "Rate limit exceeded"
- После превышения лимита добавляется задержка 2 секунды перед сбросом счетчика
- Клиент получает уведомление о сбросе ограничения через событие 'rateLimitReset'
- Настройки ограничителя можно изменить через переменные окружения:
  - `RATE_LIMIT_MAX_REQUESTS` - максимальное количество запросов в окне времени
  - `RATE_LIMIT_WINDOW_MS` - размер окна времени в миллисекундах

## Установка и запуск

1. Клонировать репозиторий
2. Установить зависимости: `npm install`
3. Создать файл `.env` на основе `.env.example`
4. Собрать проект: `npm run build`
5. Запустить сервер: `npm start`

Для разработки можно использовать: `npm run dev`

## Структура проекта

- `src/configs` - конфигурационные файлы
- `src/handlers` - обработчики сокетов
- `src/middleware` - промежуточное ПО
- `src/models` - модели данных
- `src/services` - сервисы
- `src/types` - типы TypeScript
- `src/server.ts` - основной файл сервера 